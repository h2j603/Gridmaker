<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1280, initial-scale=1.0">
<title>Grid Maker</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
.container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 20px rgba(0,0,0,0.08); }
.header { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
.header h1 { color: #111827; font-size: 2em; margin-bottom: 8px; }
.view-toggle { display: flex; gap: 8px; margin-bottom: 20px; }
.view-btn { padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer; font-weight: 500; transition: all 0.2s; }
.view-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
.workspace { display: grid; grid-template-columns: 320px 1fr 400px; gap: 30px; }
.panel { background: #f9fafb; border-radius: 8px; padding: 20px; }
.panel h3 { color: #111827; font-size: 0.95em; margin-bottom: 16px; font-weight: 600; }
.control-group { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb; }
.control-group:last-child { border-bottom: none; }
.control-label { display: block; color: #374151; font-size: 0.85em; font-weight: 500; margin-bottom: 6px; }
.control-input, .control-select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white; }
.input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
.btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; margin-bottom: 8px; font-size: 14px; }
.btn:disabled { background: #d1d5db; cursor: not-allowed; }
.btn-primary { background: #3b82f6; color: white; }
.btn-primary:hover:not(:disabled) { background: #2563eb; }
.btn-secondary { background: #e5e7eb; color: #374151; }
.btn-secondary:hover:not(:disabled) { background: #d1d5db; }
.btn-group { display: flex; gap: 8px; }

.canvas { 
  background: whitesmoke; border-radius: 8px; padding: 20px; min-height: 600px; 
  transition: all 0.3s;
  transform-origin: top center; 
}
.canvas.mobile-view { 
  max-width: 375px; 
  margin: 0 auto; 
  min-height: auto; 
}
.canvas.mobile-view .grid-container {
  min-height: auto; 
}

/* [ìˆ˜ì •] ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆëŠ” ì´ì œ ëª¨ë“ˆì˜ ì ˆëŒ€ ìœ„ì¹˜ë¥¼ ìœ„í•œ ë˜í¼ì„ */
.grid-container { 
  display: grid; 
  gap: 10px; 
  min-height: 500px; 
  /* [ìˆ˜ì •] auto-flowë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ. 
     grid-template-rowsë¥¼ ë™ì ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë†’ì´ë¥¼ ë§ì¶¤ */
  grid-auto-rows: minmax(10px, auto); /* ìµœì†Œ í–‰ ë†’ì´ */
}
.module { 
  /* [ìˆ˜ì •] position: relative ì œê±°. ê·¸ë¦¬ë“œ ì¢Œí‘œë¡œ ì§ì ‘ ì œì–´ */
  background: #8c6c3c; 
  border-radius: 0; 
  min-height: 60px; 
  cursor: pointer; 
  border: 2px solid transparent; 
  transition: all 0.2s; 
  overflow: hidden; 
}
.module:hover { border-color: #3b82f6; transform: translateY(-2px); }
.module.selected { border-color: #ef4444; border-width: 3px; }
.module[data-group-id] { box-shadow: 0 0 0 2px #a5b4fc inset; }
.module[data-group-id]:hover { border-color: #3b82f6; }
.module.selected[data-group-id] { border-color: #ef4444; box-shadow: 0 0 0 3px #ef4444 inset; }

.module.is-hidden {
  opacity: 0.4;
  border-style: dashed;
  border-color: #9ca3af;
  background-image: repeating-linear-gradient(
    -45deg,
    rgba(120, 120, 120, 0.1),
    rgba(120, 120, 120, 0.1) 5px,
    transparent 5px,
    transparent 10px
  );
}
.module.is-hidden:hover {
  opacity: 0.6;
  border-color: #3b82f6;
}
.module-hidden-badge {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(239, 68, 68, 0.85);
  color: white;
  font-size: 11px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 4px;
  z-index: 10;
  pointer-events: none; 
}

.module.dragging { opacity: 0.5; }
.module.warning { border-color: #f59e0b; border-width: 2px; }

/* [ìˆ˜ì •] ëª¨ë“ˆ ë‚´ë¶€ UI ìœ„ì¹˜ ì¡ê¸° ìœ„í•´ relative ì¶”ê°€ */
.module-content-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
}
.module-info { position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; z-index: 10; }
.module-warning { position: absolute; top: 4px; right: 28px; background: rgba(245, 158, 11, 0.9); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; z-index: 10; }
.module-delete { position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; cursor: pointer; display: none; font-size: 14px; z-index: 10; }
.module:hover .module-delete { display: block; }
.module-drag-handle { position: absolute; bottom: 4px; right: 4px; width: 24px; height: 24px; background: rgba(0,0,0,0.5); color: white; border-radius: 4px; cursor: move; display: none; justify-content: center; align-items: center; font-size: 16px; line-height: 1; padding-bottom: 2px; z-index: 10; }
.module:hover .module-drag-handle { display: flex; }

.module-content { padding: 30px 10px 10px; font-size: 14px; color: #333; }
.module-content.image { padding: 0; width: 100%; height: 100%; object-fit: cover; }
.module[data-type="image"] { background: #e0e0e0; }
.module[data-type="text"] { background: #ffffff; border: 1px solid #e0e0e0; }
.module[data-type="text"]:hover { border-color: #3b82f6; }

.stats { background: #eff6ff; padding: 12px; border-radius: 6px; margin-bottom: 16px; }
.stats-item { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85em; }
.mode-selector { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
.mode-option { padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white; }
.mode-option:hover { border-color: #3b82f6; }
.mode-option.selected { border-color: #3b82f6; background: #eff6ff; }
.mode-option-title { font-weight: 600; font-size: 0.9em; margin-bottom: 4px; }
.mode-option-desc { font-size: 0.75em; color: #6b7280; }
.custom-offset { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
.mode-hint { font-size: 0.75em; color: #6b7280; margin-top: 6px; padding: 8px; background: #f0f9ff; border-radius: 4px; }
.hint-text { font-size: 0.75em; color: #6b7280; margin-top: 4px; }
.lock-toggle { display: flex; align-items: center; gap: 8px; background: #f0f9ff; padding: 10px; border-radius: 6px; margin-top: 12px; }
.lock-toggle label { margin-bottom: 0; font-size: 0.9em; font-weight: 500; }

.visibility-toggle {
  margin-top: 16px;
  padding: 12px;
  background: #f0f9ff;
  border-radius: 6px;
}
.visibility-toggle-item {
  display: flex;
  align-items: center;
  gap: 8px;
}
.visibility-toggle-item:first-child {
  margin-bottom: 8px;
}
.visibility-toggle-item label {
  font-size: 0.9em;
  font-weight: 500;
  color: #374151;
  margin-bottom: 0; 
}

.code-tabs { display: flex; gap: 8px; margin-bottom: 12px; border-bottom: 2px solid #e5e7eb; }
.code-tab { padding: 8px 16px; background: transparent; border: none; color: #6b7280; cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -2px; }
.code-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
.code-display { background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.6; max-height: 500px; overflow-y: auto; white-space: pre; }
.toast { position: fixed; bottom: 20px; right: 20px; background: #111827; color: white; padding: 12px 20px; border-radius: 8px; z-index: 1000; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Grid Maker</h1>
    <p>ì»´í¬ë„ŒíŠ¸ + íˆìŠ¤í† ë¦¬ + ê·¸ë£¹í™” + ì¢Œí‘œ ê¸°ë°˜ ë ˆì´ì•„ì›ƒ</p> </div>

  <div class="view-toggle">
    <button class="view-btn active" onclick="switchView('desktop')">ğŸ–¥ï¸ ë°ìŠ¤í¬í†±</button>
    <button class="view-btn" onclick="switchView('mobile')">ğŸ“± ëª¨ë°”ì¼ í”„ë¦¬ë·°</button>
  </div>

  <div class="workspace">
    <div class="panel">
      <div class="control-group">
        <h3>ğŸ“Š ë°ìŠ¤í¬í†± ì„¤ì •</h3>
        <div class="stats">
          <div class="stats-item"><span>ì»¬ëŸ¼</span><span id="stat-columns">6ê°œ</span></div>
          <div class="stats-item"><span>ê°­</span><span id="stat-gap">10px</span></div>
          <div class="stats-item"><span>ëª¨ë“ˆ</span><span id="stat-modules">0ê°œ</span></div>
        </div>
        <label class="control-label">ì»¬ëŸ¼ ìˆ˜</label>
        <input type="number" id="columns" class="control-input" min="1" max="12" value="6">
        <label class="control-label" style="margin-top: 12px">ê°­ í¬ê¸° (px)</label>
        <input type="number" id="gap" class="control-input" min="0" max="50" value="10">
        
        <label class="control-label" style="margin-top: 12px">ìº”ë²„ìŠ¤ ë°°ìœ¨</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input type="range" id="canvas-scale" class="control-input" min="25" max="150" value="100" style="flex-grow: 1; padding: 0;">
          <span id="scale-readout" style="font-size: 0.9em; width: 45px; text-align: right;">100%</span>
        </div>
        </div>

      <div class="control-group">
        <h3>â• ì»¤ìŠ¤í…€ ëª¨ë“ˆ ì¶”ê°€</h3>
        <label class="control-label">ëª¨ë“ˆ íƒ€ì…</label>
        <select id="custom-type" class="control-select" style="margin-bottom: 8px;">
          <option value="box" selected>Box (ìƒ‰ìƒ)</option>
          <option value="text">Text (í…ìŠ¤íŠ¸)</option>
          <option value="image">Image (ì´ë¯¸ì§€)</option>
        </select>
        <div class="input-group">
          <input type="number" id="custom-col" class="control-input" placeholder="ì»¬ëŸ¼" min="1" value="2">
          <input type="number" id="custom-row" class="control-input" placeholder="ë¡œìš°" min="1" value="2">
        </div>
        <label class="control-label" style="margin-top: 8px">ë°°ê²½ìƒ‰ (Box íƒ€ì… ì „ìš©)</label>
        <input type="color" id="custom-color" class="control-input" value="#8c6c3c" style="height: 40px; cursor: pointer;">
        <div style="display: flex; align-items: center; gap: 5px; margin-top: 5px;">
          <input type="checkbox" id="custom-transparent" onchange="toggleColorPicker('custom', this.checked)">
          <label for="custom-transparent" style="font-size: 0.85em;">ë°°ê²½ íˆ¬ëª…</label>
        </div>
        <label class="control-label" style="margin-top: 12px">ìœ¤ê³½ì„  ìƒ‰</label>
        <input type="color" id="custom-border-color" class="control-input" value="#000000" style="height: 40px; cursor: pointer;">
        <label class="control-label" style="margin-top: 12px">ìœ¤ê³½ì„  ë‘ê»˜ (px)</label>
        <input type="number" id="custom-border-width" class="control-input" value="0" min="0" max="20">
        <button class="btn btn-primary" onclick="addCustomModule()" style="margin-top: 12px">ëª¨ë“ˆ ì¶”ê°€</button>
      </div>

      <div class="control-group" id="edit-panel" style="display: none;">
        <h3>âœï¸ ëª¨ë“ˆ í¸ì§‘</h3>
        <label class="control-label">ëª¨ë“ˆ íƒ€ì…</label>
        <select id="edit-type" class="control-select" style="margin-bottom: 12px;">
          <option value="box">Box (ìƒ‰ìƒ)</option>
          <option value="text">Text (í…ìŠ¤íŠ¸)</option>
          <option value="image">Image (ì´ë¯¸ì§€)</option>
        </select>
        <label class="control-label">Group ID (ê·¸ë£¹í™”)</label>
        <input type="text" id="edit-group-id" class="control-input" placeholder="ì˜ˆ: header-group">

        <label class="control-label" style="margin-top: 12px">ë°ìŠ¤í¬í†± ì»¬ëŸ¼ span</label>
        <input type="number" id="edit-col" class="control-input" min="1" max="12">
        <label class="control-label" style="margin-top: 12px">ë°ìŠ¤í¬í†± ë¡œìš° span</label>
        <input type="number" id="edit-row" class="control-input" min="1" max="10">
        <label class="control-label" style="margin-top: 12px">ëª¨ë°”ì¼ ì»¬ëŸ¼ span (ì„ íƒ)</label>
        <input type="number" id="edit-mobile-col" class="control-input" min="1" max="12" placeholder="ë¹„ì›Œë‘ë©´ ìë™">
        <div class="hint-text" id="mobile-span-hint">ìë™: ë¹„ìœ¨ ê³„ì‚°</div>
        <label class="control-label" style="margin-top: 12px">ë°°ê²½ìƒ‰ (Box íƒ€ì… ì „ìš©)</label>
        <input type="color" id="edit-color" class="control-input" style="height: 40px; cursor: pointer;">
        <div style="display: flex; align-items: center; gap: 5px; margin-top: 5px;">
          <input type="checkbox" id="edit-transparent" onchange="toggleColorPicker('edit', this.checked)">
          <label for="edit-transparent" style="font-size: 0.85em;">ë°°ê²½ íˆ¬ëª…</label>
        </div>
        <label class="control-label" style="margin-top: 12px">ìœ¤ê³½ì„  ìƒ‰</label>
        <input type="color" id="edit-border-color" class="control-input" style="height: 40px; cursor: pointer;">
        <label class="control-label" style="margin-top: 12px">ìœ¤ê³½ì„  ë‘ê»˜ (px)</label>
        <input type="number" id="edit-border-width" class="control-input" value="0" min="0" max="20">
        
        <div class="visibility-toggle">
          <div class="visibility-toggle-item">
            <input type="checkbox" id="edit-hidden-desktop">
            <label for="edit-hidden-desktop">ğŸ–¥ï¸ ë°ìŠ¤í¬í†±ì—ì„œ ìˆ¨ê¸°ê¸°</label>
          </div>
          <div class="visibility-toggle-item">
            <input type="checkbox" id="edit-hidden-mobile">
            <label for="edit-hidden-mobile">ğŸ“± ëª¨ë°”ì¼ì—ì„œ ìˆ¨ê¸°ê¸°</label>
          </div>
        </div>
        
        <button class="btn btn-secondary" style="margin-top: 12px" onclick="deleteSelected()">ğŸ—‘ï¸ ì„ íƒ ëª¨ë“ˆ ì‚­ì œ</button>
      </div>

      <div class="control-group">
        <h3>ğŸ“± ëª¨ë°”ì¼ ë°˜ì‘í˜• ëª¨ë“œ</h3>
        <label class="control-label">ëª¨ë°”ì¼ ëª©í‘œ ì»¬ëŸ¼ ìˆ˜</label>
        <input type="number" id="target-columns" class="control-input" min="1" max="12" value="2">
        <div class="lock-toggle">
          <input type="checkbox" id="mobile-order-lock" onchange="toggleMobileOrderLock(event)">
          <label for="mobile-order-lock">ğŸ”’ ëª¨ë°”ì¼ ìˆœì„œ ë™ê¸°í™”</label>
        </div>
        <label class="control-label" style="margin-top: 12px">ë³€í™˜ ëª¨ë“œ</label>
        <div class="mode-selector">
          <div class="mode-option selected" onclick="selectMode('reflow')" data-mode="reflow">
            <div class="mode-option-title">ğŸ”„ ë¦¬í”Œë¡œìš° (ìë™ ë°°ì¹˜)</div>
            <div class="mode-option-desc">ìˆœì„œëŒ€ë¡œ ì¬ë°°ì¹˜ (ê¸°ë³¸)</div>
          </div>
          <div class="mode-option" onclick="selectMode('center')" data-mode="center">
            <div class="mode-option-title">ğŸ—„ï¸ ì¤‘ì•™ ìœ ì§€</div>
            <div class="mode-option-desc">ë°ìŠ¤í¬í†± ê¸°ì¤€, ì–‘ë ì œê±°</div>
          </div>
          <div class="mode-option" onclick="selectMode('left')" data-mode="left">
            <div class="mode-option-title">â¬…ï¸ ì™¼ìª½ ìœ ì§€</div>
            <div class="mode-option-desc">ë°ìŠ¤í¬í†± ê¸°ì¤€, ì˜¤ë¥¸ìª½ ì œê±°</div>
          </div>
          <div class="mode-option" onclick="selectMode('right')" data-mode="right">
            <div class="mode-option-title">â¡ï¸ ì˜¤ë¥¸ìª½ ìœ ì§€</div>
            <div class="mode-option-desc">ë°ìŠ¤í¬í†± ê¸°ì¤€, ì™¼ìª½ ì œê±°</div>
          </div>
        </div>
        <div class="mode-hint" id="mode-hint">6ì—´ â†’ 2ì—´ë¡œ ë¦¬í”Œë¡œìš°</div>
      </div>

      <div class="control-group">
        <h3>ğŸ”§ ë„êµ¬</h3>
        <div class="btn-group">
          <button class="btn btn-secondary" id="undo-btn" onclick="undo()" disabled>â†©ï¸ ì‹¤í–‰ ì·¨ì†Œ</button>
          <button class="btn btn-secondary" id="redo-btn" onclick="redo()" disabled>â†ªï¸ ë‹¤ì‹œ ì‹¤í–‰</button>
        </div>
        <button class="btn btn-secondary" onclick="clearAll()" style="background: #fee2e2; color: #dc2626; margin-top: 8px;">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
      </div>
    </div>

    <div class="canvas" id="canvas" onclick="handleCanvasClick(event)">
      <div class="grid-container" id="grid"></div>
    </div>

    <div class="panel">
      <h3>ğŸ’» ìƒì„±ëœ ì½”ë“œ</h3>
      <div class="code-tabs">
        <button class="code-tab active" onclick="switchTab('html', event)">HTML</button>
        <button class="code-tab" onclick="switchTab('css', event)">CSS</button>
      </div>
      <div class="code-display" id="code-display"></div>
      <button class="btn btn-primary" style="margin-top: 12px" onclick="copyCode()">ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬</button>
    </div>
  </div>
</div>

<div id="toast" class="toast" style="display: none;"></div>

<script>
let modules = [];
let desktopColumns = 6, desktopGap = 10;
let targetColumns = 2, mobileGap = 10;
let responsiveMode = 'reflow';
let currentView = 'desktop', selectedModule = null, activeTab = 'html', draggedIndex = null;
let desktopOrder = [], mobileOrder = [];
let mobileOrderLocked = false;
let history = [];
let historyIndex = -1;

/* --- [ì‹ ê·œ] ë ˆì´ì•„ì›ƒ ê³„ì‚° ìºì‹œ --- */
// ê³„ì‚° ë¹„ìš©ì´ ë¹„ì‹¸ë¯€ë¡œ ê²°ê³¼ë¥¼ ìºì‹œ
let layoutCache = new Map(); 

function deepCopy(obj) {
  return JSON.parse(JSON.stringify(obj));
}

function saveState() {
  if (historyIndex < history.length - 1) {
    history.splice(historyIndex + 1);
  }
  const state = {
    modules: deepCopy(modules),
    desktopOrder: [...desktopOrder],
    mobileOrder: [...mobileOrder],
    selectedModuleId: selectedModule !== null ? modules[selectedModule].id : null,
    // [ì¶”ê°€] ê·¸ë¦¬ë“œ ì„¤ì •ë„ ì €ì¥
    desktopColumns, desktopGap, targetColumns, responsiveMode
  };
  history.push(state);
  historyIndex = history.length - 1;
  if (history.length > 100) {
    history.shift();
    historyIndex--;
  }
  updateUndoRedoButtons();
}

function loadState(state) {
  if (!state) return;
  modules = deepCopy(state.modules);
  desktopOrder = [...state.desktopOrder];
  mobileOrder = [...state.mobileOrder];
  
  // [ì¶”ê°€] ê·¸ë¦¬ë“œ ì„¤ì • ë³µì›
  desktopColumns = state.desktopColumns || 6;
  desktopGap = state.desktopGap || 10;
  targetColumns = state.targetColumns || 2;
  responsiveMode = state.responsiveMode || 'reflow';
  
  // UI ë™ê¸°í™”
  document.getElementById('columns').value = desktopColumns;
  document.getElementById('gap').value = desktopGap;
  document.getElementById('target-columns').value = targetColumns;
  document.querySelectorAll('.mode-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.mode === responsiveMode);
  });

  if (state.selectedModuleId !== null) {
    selectedModule = modules.findIndex(m => m.id === state.selectedModuleId);
    if (selectedModule === -1) selectedModule = null; 
  } else {
    selectedModule = null;
  }
  
  invalidateLayoutCache(); // [ìˆ˜ì •] ìƒíƒœ ë³µì› ì‹œ ìºì‹œ ì´ˆê¸°í™”
  render();
  updateEditPanel(); 
  updateUndoRedoButtons();
  updateModeHint();
}

function undo() {
  if (historyIndex > 0) {
    historyIndex--;
    loadState(history[historyIndex]);
  }
}
function redo() {
  if (historyIndex < history.length - 1) {
    historyIndex++;
    loadState(history[historyIndex]);
  }
}
function updateUndoRedoButtons() {
  document.getElementById('undo-btn').disabled = (historyIndex <= 0);
  document.getElementById('redo-btn').disabled = (historyIndex >= history.length - 1);
}

function toggleColorPicker(prefix, isTransparent) {
  const colorInput = document.getElementById(prefix + '-color');
  colorInput.disabled = isTransparent;
  colorInput.style.opacity = isTransparent ? 0.5 : 1;
  if (prefix === 'edit' && selectedModule !== null) {
    const m = modules[selectedModule];
    if (m.transparent !== isTransparent) {
        m.transparent = isTransparent;
        render();
        saveState();
    }
  }
}

// [ìˆ˜ì •] 2. 'ë¦¬í”Œë¡œìš°' ëª¨ë“œ í¬ê¸° ì¶•ì†Œ ë¬¸ì œ ìˆ˜ì • (Math.ceil ì‚¬ìš©)
function calculateMobileSpan(desktopCol, desktopCols, targetCols) {
  const ratio = desktopCol / desktopCols;
  // [ìˆ˜ì •] Math.round ëŒ€ì‹  Math.ceilì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“ˆì´ ë¶ˆí•„ìš”í•˜ê²Œ ì‘ì•„ì§€ëŠ” ê²ƒì„ ë°©ì§€
  const calculated = Math.ceil(ratio * targetCols);
  return Math.max(1, Math.min(calculated, targetCols));
}

function getMobileSpan(module) {
  const clampedTarget = Math.min(module.mobileCol, targetColumns);
  if(module.mobileCol !== undefined && module.mobileCol !== null && module.mobileCol !== '') {
    return Math.max(1, clampedTarget);
  }
  return calculateMobileSpan(module.col, desktopColumns, targetColumns);
}

function switchView(view) {
  currentView = view;
  document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.view-btn[onclick="switchView('${view}')"]`).classList.add('active');
  document.getElementById('canvas').classList.toggle('mobile-view', view === 'mobile');
  deselectModule(); 
  render(); // [ìˆ˜ì •] ë·°ë§Œ ì „í™˜í•˜ë¯€ë¡œ ìºì‹œ ì´ˆê¸°í™” í•„ìš” ì—†ìŒ
}

// [ìˆ˜ì •] selectMode - ë¹„í™œì„±í™” ì œê±°
function selectMode(mode) {
  responsiveMode = mode;
  document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('selected'));
  document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
  updateModeHint();
  updateCode(); // CSS ìƒì„± ë¡œì§ì´ ë³€ê²½ë¨
  showToast(getModeLabel(mode) + ' ëª¨ë“œ');
  // [ìˆ˜ì •] ëª¨ë“œ ë³€ê²½ì€ ë Œë”ë§ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ (CSS ì½”ë“œ ìƒì„±ì—ë§Œ ì˜í–¥)
  // í•˜ì§€ë§Œ 'ë¦¬í”Œë¡œìš°' ëª¨ë“œê°€ ì•„ë‹ˆë©´ ëª¨ë°”ì¼ ë·°ì˜ ë ˆì´ì•„ì›ƒ ê³„ì‚°ì´ ë‹¬ë¼ì§€ë¯€ë¡œ render() í˜¸ì¶œ
  if (currentView === 'mobile') {
      render();
  }
  saveState(); // [ìˆ˜ì •] ëª¨ë“œ ë³€ê²½ë„ íˆìŠ¤í† ë¦¬ì— ì €ì¥
}

function getModeLabel(mode) {
  return {'reflow':'ë¦¬í”Œë¡œìš°','center':'ì¤‘ì•™ ìœ ì§€','left':'ì™¼ìª½ ìœ ì§€','right':'ì˜¤ë¥¸ìª½ ìœ ì§€'}[mode];
}

// [ìˆ˜ì •] updateModeHint - ëª¨ë“  ëª¨ë“œì— ëŒ€í•œ íŒíŠ¸ ì œê³µ
function updateModeHint() {
  const hint = document.getElementById('mode-hint');
  let text = `${desktopColumns}ì—´ â†’ ${targetColumns}ì—´`;
  if (responsiveMode === 'reflow') {
    hint.textContent = `${text} (ë¦¬í”Œë¡œìš°)`;
  } else if (responsiveMode === 'center') {
    const drop = desktopColumns - targetColumns;
    hint.textContent = `${text} (ì¤‘ì•™ ìœ ì§€ - ì–‘ìª½ ${drop}ì—´ ì œê±°)`;
  } else if (responsiveMode === 'left') {
    const drop = desktopColumns - targetColumns;
    hint.textContent = `${text} (ì™¼ìª½ ìœ ì§€ - ì˜¤ë¥¸ìª½ ${drop}ì—´ ì œê±°)`;
  } else if (responsiveMode === 'right') {
    const drop = desktopColumns - targetColumns;
    hint.textContent = `${text} (ì˜¤ë¥¸ìª½ ìœ ì§€ - ì™¼ìª½ ${drop}ì—´ ì œê±°)`;
  }
}

function updateMobileSpanHint() {
  if(selectedModule === null) return;
  const m = modules[selectedModule];
  const auto = calculateMobileSpan(m.col, desktopColumns, targetColumns);
  const hint = document.getElementById('mobile-span-hint');
  hint.textContent = `ìë™: ${auto}ì—´ (${m.col}/${desktopColumns} Ã— ${targetColumns})`;
}

function clamp(value, min, max) {
  return Math.max(min, Math.min(value, max));
}

function toggleMobileOrderLock(event) {
  mobileOrderLocked = event.target.checked;
  if (mobileOrderLocked) {
    mobileOrder = [...desktopOrder];
    showToast('ëª¨ë°”ì¼ ìˆœì„œê°€ ë°ìŠ¤í¬í†±ì— ë™ê¸°í™”ë©ë‹ˆë‹¤.');
    invalidateLayoutCache(); // [ìˆ˜ì •]
    render();
    saveState(); 
  } else {
    showToast('ëª¨ë°”ì¼ ìˆœì„œ ë™ê¸°í™” í•´ì œ');
  }
}

/* --- [ì‹ ê·œ] ë ˆì´ì•„ì›ƒ ìºì‹œ ë¬´íš¨í™” --- */
function invalidateLayoutCache() {
  layoutCache.clear();
}

/* --- [ì‹ ê·œ] í•µì‹¬: ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ê³„ì‚° í•¨ìˆ˜ --- */
// ì´ í•¨ìˆ˜ëŠ” ëª¨ë“ˆ ìˆœì„œ, í¬ê¸°, ì»¬ëŸ¼ ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê° ëª¨ë“ˆì˜ (row, col) ì‹œì‘ì ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
function calculateFullLayout(order, modules, columns) {
  const cacheKey = `${currentView}-${responsiveMode}-${order.join(',')}-${columns}`;
  if (layoutCache.has(cacheKey)) {
    return layoutCache.get(cacheKey);
  }

  const layout = new Map();
  // gridMatrixëŠ” ê·¸ë¦¬ë“œì˜ ê° ì…€ì´ ì±„ì›Œì¡ŒëŠ”ì§€(ëª¨ë“ˆ ID) ì—¬ë¶€ë¥¼ ì¶”ì í•©ë‹ˆë‹¤.
  const gridMatrix = [];
  let maxRow = 0; // í˜„ì¬ê¹Œì§€ ì±„ì›Œì§„ ìµœëŒ€ row

  // 'ë¦¬í”Œë¡œìš°'ê°€ ì•„ë‹Œ ëª¨ë°”ì¼ ëª¨ë“œ(ì¤‘ì•™, ì™¼ìª½, ì˜¤ë¥¸ìª½)ëŠ” ë°ìŠ¤í¬í†± ë ˆì´ì•„ì›ƒì„ ê¸°ë°˜ìœ¼ë¡œ CSSì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
  // ìº”ë²„ìŠ¤ í”„ë¦¬ë·°ì—ì„œëŠ” 'ë¦¬í”Œë¡œìš°'ì™€ ë™ì¼í•˜ê²Œ ë³´ì—¬ì£¼ë˜, CSS ìƒì„± ì‹œì—ë§Œ ë‹¤ë¥´ê²Œ ì‘ë™í•©ë‹ˆë‹¤.
  // [ìˆ˜ì •] ì‚¬ìš©ìì˜ ìš”ì²­ì€ 'CSS ìƒì„±'ì— ê´€í•œ ê²ƒì´ì—ˆìŒ.
  // í•˜ì§€ë§Œ í”„ë¦¬ë·°ë„ ê·¸ëŸ´ë“¯í•˜ê²Œ ë³´ì—¬ì£¼ê¸° ìœ„í•´, 'ë¦¬í”Œë¡œìš°'ê°€ ì•„ë‹Œ ëª¨ë“œì¼ ë•Œ ëª¨ë°”ì¼ ë·°ë¼ë©´
  // ë°ìŠ¤í¬í†± ë ˆì´ì•„ì›ƒì„ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°í•´ì•¼ í•©ë‹ˆë‹¤.
  
  if (currentView === 'mobile' && responsiveMode !== 'reflow') {
    // 'ì¤‘ì•™/ì™¼ìª½/ì˜¤ë¥¸ìª½' ëª¨ë“œì˜ ëª¨ë°”ì¼ í”„ë¦¬ë·°ëŠ” 
    // ë°ìŠ¤í¬í†± ë ˆì´ì•„ì›ƒì„ ê°€ì ¸ì™€ì„œ CSSì—ì„œ í•˜ë“¯ í•„í„°ë§/ë³€í™˜í•©ë‹ˆë‹¤.
    const desktopLayout = getLayout('desktop');
    const colsToDrop = desktopColumns - targetColumns;
    let colsToDropLeft = 0;

    if (responsiveMode === 'center') {
      colsToDropLeft = Math.floor(colsToDrop / 2);
    } else if (responsiveMode === 'right') {
      colsToDropLeft = colsToDrop;
    }
    // 'left' ëª¨ë“œëŠ” colsToDropLeft = 0

    desktopLayout.forEach((pos, id) => {
      const module = modules.find(m => m.id === id);
      if (!module) return;

      const { startCol, startRow } = pos;
      const endCol = startCol + module.col - 1;
      
      const desktopKeepStart = 1 + colsToDropLeft;
      const desktopKeepEnd = desktopColumns - (colsToDrop - colsToDropLeft);

      // ìˆ¨ê¹€ ì²˜ë¦¬ (ê²½ê³„ì— ê±¸ì¹˜ê±°ë‚˜ ë°–ì— ìˆëŠ” ê²½ìš°)
      if (startCol < desktopKeepStart || endCol > desktopKeepEnd) {
        layout.set(id, { startCol: 1, startRow: 1, hidden: true, span: 1 }); // ìˆ¨ê¹€ í”Œë˜ê·¸
        return;
      }
      
      // 'ìœ ì§€' ì˜ì—­ì— í¬í•¨ëœ ê²½ìš°
      const newStartCol = (startCol - colsToDropLeft);
      // [ìˆ˜ì •] 1. 'ì¤‘ì•™/ì™¼ìª½/ì˜¤ë¥¸ìª½' í”„ë¦¬ë·° ë²„ê·¸ ìˆ˜ì •
      // CSS ìƒì„± ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ, ìƒˆ ì‹œì‘ì ì—ì„œ ê·¸ë¦¬ë“œ ëì„ ë„˜ì§€ ì•Šë„ë¡ ìŠ¤íŒ¬ì„ ì¬ê³„ì‚°
      const newSpan = Math.min(module.col, columns - newStartCol + 1); // 'columns' is targetColumns
      
      layout.set(id, {
        startCol: newStartCol,
        startRow: startRow, // rowëŠ” ë°ìŠ¤í¬í†±ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€
        hidden: false,
        span: newSpan 
      });
      maxRow = Math.max(maxRow, startRow + module.row - 1);
    });
    
    layout.set('__maxRow', maxRow + 1); // ê·¸ë¦¬ë“œ ì „ì²´ ë†’ì´
    layoutCache.set(cacheKey, layout);
    return layout;
  }

  // --- 'ë¦¬í”Œë¡œìš°' ëª¨ë“œ ë˜ëŠ” 'ë°ìŠ¤í¬í†±' ë·°ì¼ ë•Œ (ìë™ ë°°ì¹˜ ì‹œë®¬ë ˆì´ì…˜) ---
  for (const id of order) {
    const module = modules.find(m => m.id === id);
    if (!module) continue;

    const colSpan = (currentView === 'desktop') ? clamp(module.col, 1, columns) : getMobileSpan(module);
    const rowSpan = module.row;

    let placed = false;
    for (let r = 0; ; r++) { // ë¬´í•œíˆ rowë¥¼ íƒìƒ‰
      maxRow = Math.max(maxRow, r);
      if (placed) break;
      
      // gridMatrixì˜ rowê°€ ì¶©ë¶„í•œì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ìƒì„±
      if (!gridMatrix[r]) gridMatrix[r] = new Array(columns).fill(null);

      for (let c = 0; c <= columns - colSpan; c++) {
        if (canPlace(gridMatrix, r, c, colSpan, rowSpan, columns)) {
          placeModule(gridMatrix, r, c, colSpan, rowSpan, id, columns);
          layout.set(id, { startCol: c + 1, startRow: r + 1, hidden: false, span: colSpan });
          placed = true;
          maxRow = Math.max(maxRow, r + rowSpan - 1);
          break;
        }
      }
    }
  }

  layout.set('__maxRow', maxRow + 1); // ê·¸ë¦¬ë“œ ì „ì²´ ë†’ì´
  layoutCache.set(cacheKey, layout);
  return layout;
}

// (í—¬í¼) gridMatrixì˜ (r, c) ìœ„ì¹˜ì— (colSpan, rowSpan) í¬ê¸°ì˜ ëª¨ë“ˆì„ ë†“ì„ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
function canPlace(gridMatrix, r, c, colSpan, rowSpan, columns) {
  for (let i = r; i < r + rowSpan; i++) {
    for (let j = c; j < c + colSpan; j++) {
      if (j >= columns) return false; // ì»¬ëŸ¼ ë²”ìœ„ ì´ˆê³¼
      if (!gridMatrix[i]) gridMatrix[i] = new Array(columns).fill(null); // row ìƒì„±
      if (gridMatrix[i][j] !== null) return false; // ì´ë¯¸ ì±„ì›Œì ¸ ìˆìŒ
    }
  }
  return true;
}

// (í—¬í¼) gridMatrixì— ëª¨ë“ˆ ë°°ì¹˜ (IDë¡œ ë§ˆí‚¹)
function placeModule(gridMatrix, r, c, colSpan, rowSpan, id, columns) {
  for (let i = r; i < r + rowSpan; i++) {
    if (!gridMatrix[i]) gridMatrix[i] = new Array(columns).fill(null);
    for (let j = c; j < c + colSpan; j++) {
      if (j < columns) {
        gridMatrix[i][j] = id; // ëª¨ë“ˆ IDë¡œ ì±„ì›€
      }
    }
  }
}

/* --- [ì‹ ê·œ] ë ˆì´ì•„ì›ƒ ê°€ì ¸ì˜¤ê¸° (ìºì‹œ/ê³„ì‚°) --- */
function getLayout(view) {
  const order = (view === 'desktop') ? desktopOrder : mobileOrder;
  const columns = (view === 'desktop') ? desktopColumns : targetColumns;
  return calculateFullLayout(order, modules, columns);
}


function init() {
  // [ìˆ˜ì •] ì»¬ëŸ¼/ê°­ ë³€ê²½ ì‹œ ìºì‹œ ì´ˆê¸°í™” ë° saveState
  document.getElementById('columns').addEventListener('input', e => { 
    desktopColumns = clamp(parseInt(e.target.value) || 1, 1, 12);
    invalidateLayoutCache(); // [ìˆ˜ì •]
    updateStats(); updateModeHint(); updateMobileSpanHint(); render(); 
  });
  document.getElementById('columns').addEventListener('change', e => { saveState(); });

  document.getElementById('gap').addEventListener('input', e => { 
    desktopGap = clamp(parseInt(e.target.value) || 0, 0, 50);
    invalidateLayoutCache(); // [ìˆ˜ì •]
    updateStats(); render(); 
  });
  document.getElementById('gap').addEventListener('change', e => { saveState(); });

  document.getElementById('target-columns').addEventListener('input', e => { 
    targetColumns = clamp(parseInt(e.target.value) || 1, 1, 12); 
    invalidateLayoutCache(); // [ìˆ˜ì •]
    updateModeHint(); updateMobileSpanHint(); updateCode(); render();
  });
  document.getElementById('target-columns').addEventListener('change', e => { saveState(); });
  
  document.getElementById('canvas-scale').addEventListener('input', e => {
    const scaleValue = parseInt(e.target.value);
    document.getElementById('canvas').style.transform = `scale(${scaleValue / 100})`;
    document.getElementById('scale-readout').textContent = `${scaleValue}%`;
  });

  // --- ëª¨ë“ˆ í¸ì§‘ ë¦¬ìŠ¤ë„ˆ (ëª¨ë‘ 'change' ì´ë²¤íŠ¸ì— saveState() ì¶”ê°€) ---
  
  document.getElementById('edit-type').addEventListener('change', e => {
    if (selectedModule !== null) {
        modules[selectedModule].type = e.target.value;
        render(); // [ìˆ˜ì •] íƒ€ì… ë³€ê²½ì€ ë ˆì´ì•„ì›ƒì— ì˜í–¥ X (ìºì‹œ ì´ˆê¸°í™” ë¶ˆí•„ìš”)
        saveState();
    }
  });

  document.getElementById('edit-group-id').addEventListener('change', e => {
    if (selectedModule !== null) {
        modules[selectedModule].groupId = e.target.value.trim() || null;
        render();
        saveState();
    }
  });

  document.getElementById('edit-col').addEventListener('input', e => { 
    if(selectedModule!==null) { 
      const maxCol = desktopColumns;
      modules[selectedModule].col = clamp(parseInt(e.target.value)||1, 1, maxCol);
      e.target.value = modules[selectedModule].col; 
      updateMobileSpanHint();
      invalidateLayoutCache(); // [ìˆ˜ì •]
      render(); 
    }
  });
  document.getElementById('edit-col').addEventListener('change', e => { if(selectedModule!==null) saveState(); });

  document.getElementById('edit-row').addEventListener('input', e => { 
    if(selectedModule!==null) { 
      modules[selectedModule].row = clamp(parseInt(e.target.value)||1, 1, 99);
      e.target.value = modules[selectedModule].row;
      invalidateLayoutCache(); // [ìˆ˜ì •]
      render(); 
    }});
  document.getElementById('edit-row').addEventListener('change', e => { if(selectedModule!==null) saveState(); });

  document.getElementById('edit-mobile-col').addEventListener('input', e => { 
    if(selectedModule!==null) { 
      const val = e.target.value;
      if (val === '') {
        modules[selectedModule].mobileCol = null;
      } else {
        const maxCol = targetColumns;
        modules[selectedModule].mobileCol = clamp(parseInt(val)||1, 1, maxCol);
        e.target.value = modules[selectedModule].mobileCol;
      }
      invalidateLayoutCache(); // [ìˆ˜ì •]
      render(); 
    }
  });
  document.getElementById('edit-mobile-col').addEventListener('change', e => { if(selectedModule!==null) saveState(); });

  document.getElementById('edit-color').addEventListener('input', e => { 
      if(selectedModule!==null) { modules[selectedModule].color = e.target.value; render(); }
  });
  document.getElementById('edit-color').addEventListener('change', e => { if(selectedModule!==null) saveState(); });

  document.getElementById('edit-border-color').addEventListener('input', e => { 
    if(selectedModule!==null) { modules[selectedModule].borderColor = e.target.value; render(); }
  });
  document.getElementById('edit-border-color').addEventListener('change', e => { if(selectedModule!==null) saveState(); });

  document.getElementById('edit-border-width').addEventListener('input', e => { 
    if(selectedModule!==null) { 
      modules[selectedModule].borderWidth = clamp(parseInt(e.target.value) || 0, 0, 20);
      e.target.value = modules[selectedModule].borderWidth;
      render(); 
    }
  });
  document.getElementById('edit-border-width').addEventListener('change', e => { if(selectedModule!==null) saveState(); });

  document.getElementById('edit-hidden-desktop').addEventListener('change', e => {
    if (selectedModule !== null) {
      modules[selectedModule].hiddenDesktop = e.target.checked;
      render();
      saveState(); 
    }
  });

  document.getElementById('edit-hidden-mobile').addEventListener('change', e => {
    if (selectedModule !== null) {
      modules[selectedModule].hiddenMobile = e.target.checked;
      render();
      saveState(); 
    }
  });

  updateStats(); 
  updateModeHint(); 
  render();
  saveState(); 
}

function addCustomModule() {
  const col = clamp(parseInt(document.getElementById('custom-col').value) || 2, 1, desktopColumns);
  const row = clamp(parseInt(document.getElementById('custom-row').value) || 2, 1, 99);
  const color = document.getElementById('custom-color').value;
  const transparent = document.getElementById('custom-transparent').checked;
  const borderColor = document.getElementById('custom-border-color').value;
  const borderWidth = clamp(parseInt(document.getElementById('custom-border-width').value) || 0, 0, 20);
  const type = document.getElementById('custom-type').value; 
  
  const newModule = { 
    col, row, color, transparent, borderColor, borderWidth, 
    mobileCol: null, id: Date.now(),
    type: type, 
    groupId: null,
    hiddenDesktop: false, 
    hiddenMobile: false   
  };
  
  modules.push(newModule);
  desktopOrder.push(newModule.id);
  
  if (mobileOrderLocked) {
    mobileOrder.push(newModule.id);
  } else {
    mobileOrder.push(newModule.id);
  }
  
  document.getElementById('custom-transparent').checked = false;
  toggleColorPicker('custom', false);
  document.getElementById('custom-border-width').value = 0;

  showToast(`${col}Ã—${row} ${type} ëª¨ë“ˆ ì¶”ê°€`);
  invalidateLayoutCache(); // [ìˆ˜ì •]
  render();
  saveState(); 
}

function updateEditPanel() {
  if (selectedModule === null) {
    document.getElementById('edit-panel').style.display = 'none';
    return;
  }
  
  const m = modules[selectedModule];
  if (!m) { 
    document.getElementById('edit-panel').style.display = 'none';
    return;
  }
  
  document.getElementById('edit-panel').style.display = 'block';
  document.getElementById('edit-type').value = m.type || 'box'; 
  document.getElementById('edit-group-id').value = m.groupId || ''; 
  document.getElementById('edit-col').value = clamp(m.col, 1, desktopColumns);
  document.getElementById('edit-col').max = desktopColumns;
  document.getElementById('edit-row').value = m.row;
  document.getElementById('edit-mobile-col').value = m.mobileCol !== null ? clamp(m.mobileCol, 1, targetColumns) : '';
  document.getElementById('edit-mobile-col').max = targetColumns;
  document.getElementById('edit-color').value = m.color || '#8c6c3c';
  const isTransparent = m.transparent || false;
  document.getElementById('edit-transparent').checked = isTransparent;
  toggleColorPicker('edit', isTransparent);
  document.getElementById('edit-border-color').value = m.borderColor || '#000000';
  document.getElementById('edit-border-width').value = m.borderWidth || 0;
  document.getElementById('edit-hidden-desktop').checked = m.hiddenDesktop || false;
  document.getElementById('edit-hidden-mobile').checked = m.hiddenMobile || false;

  updateMobileSpanHint();
}

function selectModule(index) {
  if (selectedModule === index) return; 
  selectedModule = index;
  updateEditPanel(); 
  render(); 
}
function handleCanvasClick(event) {
  if (event.target.id === 'canvas' || event.target.id === 'grid') {
    deselectModule();
  }
}
function deselectModule() {
  if (selectedModule !== null) {
    selectedModule = null;
    updateEditPanel(); 
    render();
  }
}

function deleteSelected() {
  if(selectedModule !== null) {
    deleteModule(selectedModule, new Event('click')); 
  }
}

function deleteModule(index, event) {
  event.stopPropagation();
  const idToDelete = modules[index].id;
  
  modules.splice(index, 1);
  desktopOrder = desktopOrder.filter(id => id !== idToDelete);
  mobileOrder = mobileOrder.filter(id => id !== idToDelete);

  if(selectedModule === index) {
    selectedModule = null;
    updateEditPanel();
  } else if(selectedModule > index) {
    selectedModule--;
  }
  invalidateLayoutCache(); // [ìˆ˜ì •]
  render();
  saveState(); 
}

function clearAll() {
  if(confirm('ëª¨ë“  ëª¨ë“ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    modules = [];
    desktopOrder = [];
    mobileOrder = [];
    selectedModule = null;
    updateEditPanel();
    showToast('ì „ì²´ ì‚­ì œ');
    invalidateLayoutCache(); // [ìˆ˜ì •]
    render();
    saveState(); 
  }
}

// [ìˆ˜ì •] ë“œë˜ê·¸ ì‹œì‘ ì‹œ, ìˆœì„œ(index)ê°€ ì•„ë‹Œ ëª¨ë“ˆ IDë¥¼ ì €ì¥
function handleDragStart(index, event) {
  draggedIndex = index; // ë“œë¡­ ë¡œì§ì„ ìœ„í•´ ìˆœì„œ ì¸ë±ìŠ¤ë„ ìœ ì§€
  event.target.closest('.module').classList.add('dragging');
  event.dataTransfer.effectAllowed = 'move';
  
  const order = currentView === 'desktop' ? desktopOrder : mobileOrder;
  const draggedId = order[index]; // ID ì €ì¥
  const draggedModule = modules.find(m => m.id === draggedId);
  if (!draggedModule) return;
  
  event.dataTransfer.setData('text/plain', draggedId);
}

function handleDragEnd(event) {
  document.querySelectorAll('.module.dragging').forEach(el => el.classList.remove('dragging'));
  draggedIndex = null;
}
function handleDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
}

// [ìˆ˜ì •] ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§ (ìˆœì„œ ë³€ê²½)
function handleDrop(index, event) {
  event.preventDefault();
  event.stopPropagation();
  
  if(draggedIndex !== null && draggedIndex !== index) {
    const order = currentView === 'desktop' ? desktopOrder : mobileOrder;
    const draggedId = parseInt(event.dataTransfer.getData('text/plain'));
    const draggedModule = modules.find(m => m.id === draggedId);
    
    if (!draggedModule) { 
        draggedIndex = null;
        return;
    }
    const groupId = draggedModule.groupId;
    let idsToMove = [];
    if (groupId) {
        idsToMove = order.filter(id => {
            const m = modules.find(mod => mod.id === id);
            return m && m.groupId === groupId;
        });
    } else {
        idsToMove.push(draggedId);
    }
    const targetId = order[index];
    if (idsToMove.includes(targetId)) {
        draggedIndex = null;
        return; 
    }
    let newOrder = order.filter(id => !idsToMove.includes(id));
    let newDropIndex = newOrder.indexOf(targetId);
    
    // [ìˆ˜ì •] ë“œë¡­ ìœ„ì¹˜ê°€ ë“œë˜ê·¸ ì‹œì‘ ìœ„ì¹˜ë³´ë‹¤ ì•ì´ë©´ +1
    const originalDropIndexInFiltered = newOrder.indexOf(targetId);
    const originalDragIndex = order.indexOf(draggedId);
    
    if (originalDragIndex < index) {
         newDropIndex = originalDropIndexInFiltered + 1;
    } else {
         newDropIndex = originalDropIndexInFiltered;
    }

    newOrder.splice(newDropIndex, 0, ...idsToMove);

    if (currentView === 'desktop') {
      desktopOrder = newOrder;
      if (mobileOrderLocked) {
        mobileOrder = [...desktopOrder];
      }
    } else {
      mobileOrder = newOrder;
    }
    
    if (selectedModule !== null) {
        const selectedId = modules[selectedModule].id;
        selectedModule = modules.findIndex(m => m.id === selectedId);
    }
    
    invalidateLayoutCache(); // [ìˆ˜ì •]
    render();
    saveState(); 
  }
  draggedIndex = null;
}

function getOrderedModules() {
  const order = currentView === 'desktop' ? desktopOrder : mobileOrder;
  return order.map(id => modules.find(m => m.id === id)).filter(m => m);
}

function updateStats() {
  document.getElementById('stat-columns').textContent = `${desktopColumns}ê°œ`;
  document.getElementById('stat-gap').textContent = `${desktopGap}px`;
  document.getElementById('stat-modules').textContent = `${modules.length}ê°œ`;
}

// --- [ìˆ˜ì •] ë Œë”ë§ í•¨ìˆ˜ (ì ˆëŒ€ ì¢Œí‘œ ì‚¬ìš©) ---
function render() {
  const grid = document.getElementById('grid');
  const columns = currentView === 'desktop' ? desktopColumns : targetColumns;
  const gap = currentView === 'desktop' ? desktopGap : mobileGap;
  grid.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
  grid.style.gap = `${gap}px`;
  
  const layout = getLayout(currentView);
  const maxRow = layout.get('__maxRow') || 10; // ê³„ì‚°ëœ ìµœëŒ€ row
  
  // ê·¸ë¦¬ë“œì˜ ì „ì²´ ë†’ì´ë¥¼ ë™ì ìœ¼ë¡œ ì„¤ì • (ëª¨ë“ˆì´ ë„˜ì¹˜ì§€ ì•Šë„ë¡)
  grid.style.gridTemplateRows = `repeat(${maxRow}, minmax(10px, auto))`;

  const order = currentView === 'desktop' ? desktopOrder : mobileOrder;
  
  grid.innerHTML = order.map((id, i) => {
    const actualIndex = modules.findIndex(mod => mod.id === id);
    if (actualIndex === -1) return ''; 
    
    const moduleData = modules[actualIndex];
    const pos = layout.get(id);

    // ë ˆì´ì•„ì›ƒ ê³„ì‚°ì´ ì•ˆëê±°ë‚˜ ìˆ¨ê¹€ ì²˜ë¦¬ëœ ê²½ìš°
    if (!pos || pos.hidden) {
       // ëª¨ë°”ì¼ 'ì •ë ¬' ëª¨ë“œ í”„ë¦¬ë·°ì—ì„œ ìˆ¨ê¹€ ì²˜ë¦¬
       return `<div class="module is-hidden" 
                  style="grid-column: 1; grid-row: 1; display: none;"></div>`;
    }

    const { startCol, startRow, span } = pos;
    
    const isTransparent = moduleData.transparent || false;
    const bgColor = isTransparent ? 'transparent' : (moduleData.color || '#8c6c3c');
    const borderWidth = moduleData.borderWidth || 0;
    const borderColor = moduleData.borderColor || '#000000';
    const outlineStyle = borderWidth > 0 ? `outline: ${borderWidth}px solid ${borderColor}; outline-offset: -${borderWidth}px;` : '';
    
    const showWarning = currentView === 'mobile' && 
                        moduleData.col > targetColumns && 
                        (moduleData.mobileCol === null || moduleData.mobileCol === undefined || moduleData.mobileCol === '');
    
    const isHiddenInCurrentView = (currentView === 'desktop' && moduleData.hiddenDesktop) || 
                                  (currentView === 'mobile' && moduleData.hiddenMobile);
    const hiddenClass = isHiddenInCurrentView ? 'is-hidden' : '';
    const hiddenBadge = isHiddenInCurrentView ? '<div class="module-hidden-badge">ğŸš« HIDE</div>' : '';

    let innerHTML = '';
    const moduleType = moduleData.type || 'box';
    if (moduleType === 'text') {
        innerHTML = `<p class="module-content">Lorem ipsum dolor sit amet...</p>`;
    } else if (moduleType === 'image') {
        innerHTML = `<img src="https://via.placeholder.com/${span * 100}x${moduleData.row * 50}" alt="placeholder" class="module-content image">`;
    }
    
    return `
    <div class="module ${selectedModule === actualIndex ? 'selected' : ''} ${showWarning ? 'warning' : ''} ${hiddenClass}" 
         style="
           grid-column: ${startCol} / span ${span}; 
           grid-row: ${startRow} / span ${moduleData.row}; 
           background: ${moduleType === 'box' ? bgColor : ''}; 
           ${outlineStyle}
         "
         data-type="${moduleType}"
         data-group-id="${moduleData.groupId || ''}"
         onclick="selectModule(${actualIndex})"
         ondragover="handleDragOver(event)"
         ondrop="handleDrop(${i}, event)">
      
      <div class="module-content-wrapper">
        ${innerHTML} 
        ${hiddenBadge} 
        <div class="module-info">${moduleData.col}Ã—${moduleData.row}</div>
        ${showWarning ? '<div class="module-warning">!</div>' : ''}
        <button class="module-delete" onclick="deleteModule(${actualIndex}, event)">Ã—</button>
        <div class="module-drag-handle" 
             draggable="true" 
             ondragstart="handleDragStart(${i}, event)" 
             ondragend="handleDragEnd(event)">â ¿</div>
      </div>
    </div>
  `}).join('');
  
  updateStats(); 
  updateCode();
}

function generateHTML() {
  return `<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="grid-container">
${desktopOrder.map((id, i) => {
    const m = modules.find(mod => mod.id === id);
    if (!m) return '';
    const groupClass = m.groupId ? ` group-${m.groupId}` : '';
    return `    <div class="module module-${i + 1} type-${m.type || 'box'}${groupClass}">
${m.type === 'text' ? '      <p>Lorem ipsum...</p>' : (m.type === 'image' ? '      <img src="https://via.placeholder.com/150" alt="placeholder">' : '      ')}
    </div>`;
  }).join('\n')}
  </div>
</body>
</html>`;
}

// --- [ìˆ˜ì •] CSS ìƒì„± ë¡œì§ (ì¢Œí‘œ ë° ì •ë ¬ ëª¨ë“œ ë°˜ì˜) ---
function generateCSS() {
  /* [ìˆ˜ì •] ë°ìŠ¤í¬í†± ë ˆì´ì•„ì›ƒ ê³„ì‚° */
  const desktopLayout = getLayout('desktop');
  const desktopMaxRow = desktopLayout.get('__maxRow') || 10;
  
  let css = `body {
  margin: 0;
  background: whitesmoke;
  padding: ${desktopGap}px;
}

.grid-container {
  display: grid;
  grid-template-columns: repeat(${desktopColumns}, 1fr);
  gap: ${desktopGap}px;
  /* [ìˆ˜ì •] ê³„ì‚°ëœ ë†’ì´ ë°˜ì˜ */
  grid-template-rows: repeat(${desktopMaxRow}, minmax(10px, auto));
}

.module {
  min-height: 60px;
}

/* íƒ€ì…ë³„ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
.module.type-image { background: #e0e0e0; }
.module.type-image img { width: 100%; height: 100%; object-fit: cover; display: block; }
.module.type-text { background: #ffffff; padding: 10px; }

${desktopOrder.map((id, i) => {
  const m = modules.find(mod => mod.id === id);
  if (!m) return '';

  if (m.hiddenDesktop) {
    return `.module-${i + 1} {
  display: none; /* ë°ìŠ¤í¬í†± ìˆ¨ê¹€ */
}`;
  }
  
  const pos = desktopLayout.get(id);
  if (!pos) return ''; // ë ˆì´ì•„ì›ƒ ì •ë³´ ì—†ìŒ
  const { startCol, startRow } = pos;

  const isTransparent = m.transparent || false;
  const bgColor = isTransparent ? 'transparent' : (m.color || '#8c6c3c');
  const borderWidth = m.borderWidth || 0;
  const borderColor = m.borderColor || '#000000';
  const outlineStyle = borderWidth > 0 ? `\n  outline: ${borderWidth}px solid ${borderColor};\n  outline-offset: -${borderWidth}px;` : '';
  const backgroundStyle = (m.type === 'box' || !m.type) ? `background: ${bgColor};` : '';

  /* [ìˆ˜ì •] ì ˆëŒ€ ì¢Œí‘œ ì‚¬ìš© */
  return `.module-${i + 1} {
  grid-column: ${startCol} / span ${m.col};
  grid-row: ${startRow} / span ${m.row};
  ${backgroundStyle}${outlineStyle}
}`;
}).join('\n\n')}

/* ëª¨ë°”ì¼ ë°˜ì‘í˜• - ${getModeLabel(responsiveMode)} */
@media (max-width: 768px) {
  body { padding: ${mobileGap}px; }
  .grid-container {
    grid-template-columns: repeat(${targetColumns}, 1fr);
    gap: ${mobileGap}px;
    grid-template-rows: auto; /* [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„  row ë†’ì´ ìë™ */
  }
  
`;

  // [ìˆ˜ì •] ëª¨ë°”ì¼ CSS ìƒì„± ë¡œì§ (ëª¨ë“  ëª¨ë“œ)
  
  if(responsiveMode === 'reflow') {
    // ë¦¬í”Œë¡œìš° ëª¨ë“œì¼ ë•Œë§Œ ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ì¬ê³„ì‚°
    const mobileLayout = getLayout('mobile');
    const mobileMaxRow = mobileLayout.get('__maxRow') || 10;
    css += `  .grid-container { grid-template-rows: repeat(${mobileMaxRow}, minmax(10px, auto)); }\n\n`;

    css += mobileOrder.map((id, i) => {
      const m = modules.find(mod => mod.id === id);
      if (!m) return '';
      const moduleClassIndex = desktopOrder.indexOf(id) + 1;
      if (moduleClassIndex === 0) return ''; 

      if (m.hiddenMobile) {
        return `  .module-${moduleClassIndex} { display: none; /* ëª¨ë°”ì¼ ìˆ¨ê¹€ */ }`;
      }
      
      const pos = mobileLayout.get(id);
      if (!pos) return '';
      const